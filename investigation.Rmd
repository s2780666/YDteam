---
title: "IDS investigation worksheet"
author: "by YDTeam: Cecilia, Frank, Junkai, Zhandos"
date: "`r Sys.Date()`"
output: html_document
---

**Note:** You can use this file as you 'working document' where you can try out various investigation ideas and keep notes about your findings. How you use and structure this file is up to you. It is recommended that you keep notes about what you are investigating and what you find as this will make the process of creating your presentation and report easier. Please note that you _do not_ need to submit this file as part of your group project.



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-lib, message = FALSE}
library(tidyverse)
library(readr)

adjudications <- read_csv("data/CSV/AdjudicationsQ12023.csv")




```


```{r load-data}
library(tidyverse)
library(janitor)
 
adjudications <- adjudications %>%
  clean_names()

adjudications_clean <- adjudications %>%
  drop_na()


adjudications_clean <- adjudications_clean %>%
  rename(quarter = date)


glimpse(adjudications_clean)
colSums(is.na(adjudications_clean))


```
Topic 1：
Crime Patterns Across Age Groups in UK Prisons (Q1 2023)
Question:
What kinds of crimes are different age groups committing?
introduction:
Understanding how offence patterns vary across age groups is important for identifying behavioural trends within prisons.
In the Adjudications dataset (Q1 2023), prisoners are classified into age groups, and each adjudication is associated with an offence category such as Disobedience/disrespect, Unauthorized transactions, or Violence.
This section examines which age groups are responsible for particular types of offences and whether certain offences are more common among specific age ranges.
```{r}
library(dplyr)
library(ggplot2)


adjudications_clean %>%
  group_by(offence) %>%
  summarise(total = sum(count, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(total)) %>%
  slice_head(n = 6) %>%
  ggplot(aes(x = reorder(offence, total), y = total, fill = offence)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Top 6 offences (Q1 2023)",
    x = "Offence",
    y = "Total cases"
  )


```

```{r}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(forcats)
library(scales)
library(gt)
library(glue)
library(janitor)


adj <- read_csv("AdjudicationsQ12023.csv") |> clean_names()


adj_clean <- adj |>
  rename(
    age_group = age_group,
    offence   = offence,
    count     = count
  ) |>
  mutate(
    count = suppressWarnings(as.numeric(count)),
    age_group = as.character(age_group),
    offence   = as.character(offence)
  ) |>
  filter(!is.na(age_group), !is.na(offence), !is.na(count), count > 0)


age_order <- c("15 - 17","18 - 20","21 - 24","25 - 29","30 - 39","40 - 49","50 - 59","60 - 69","70 and over")
adj_clean <- adj_clean |>
  mutate(age_group = fct_relevel(age_group, age_order, after = 0))

age_offence_counts <- adj_clean |>
  group_by(age_group, offence) |>
  summarise(total = sum(count), .groups = "drop")


age_totals <- age_offence_counts |>
  group_by(age_group) |>
  summarise(age_total = sum(total), .groups = "drop")


age_offence_share <- age_offence_counts |>
  left_join(age_totals, by = "age_group") |>
  mutate(pct = total / age_total)
top_offences <- adj_clean |>
  group_by(offence) |>
  summarise(total_cases = sum(count), .groups = "drop") |>
  arrange(desc(total_cases))

top_offences |>
  mutate(
    Rank  = row_number(),
    total_cases = comma(total_cases)
  ) |>
  select(Rank, offence, total_cases) |>
  gt() |>
  tab_header(title = md("**Top offences (Q1 2023)**")) |>
  cols_label(
    offence = "Offence",
    total_cases = "Total cases"
  )
top3_by_age <- age_offence_share |>
  arrange(age_group, desc(total)) |>
  group_by(age_group) |>
  slice_head(n = 3) |>
  mutate(share = percent(pct, accuracy = 0.1)) |>
  ungroup() |>
  select(age_group, offence, total, share)

top3_by_age |>
  mutate(total = comma(total)) |>
  gt(groupname_col = "age_group") |>
  tab_header(title = md("**Top-3 offence types by age group**")) |>
  cols_label(
    offence = "Offence",
    total   = "Cases",
    share   = "Share"
  )
p_counts <- age_offence_counts |>
  ggplot(aes(x = total, y = age_group, fill = offence)) +
  geom_col() +
  geom_text(
    data = age_totals,
    aes(x = age_total, y = age_group, label = comma(age_total)),
    nudge_x = max(age_totals$age_total, na.rm = TRUE) * 0.02, 
    inherit.aes = FALSE, size = 3
  ) +
  labs(
    title = "Adjudications by Age Group and Offence (Q1 2023)",
    x = "Total Cases",
    y = "Age Group",
    fill = "Offence"
  ) +
  theme_minimal(base_size = 12)

p_counts
# ggsave("age_offence_counts.png", p_counts, width = 9, height = 6, dpi = 300)

age_offence_share <- age_offence_counts |>
  dplyr::group_by(age_group) |>
  dplyr::mutate(age_total = sum(total),
                pct = total / age_total) |>
  dplyr::ungroup()


p_share_labels <- age_offence_share |>
  dplyr::mutate(lbl = ifelse(pct >= 0.05, scales::percent(pct, accuracy = 1), "")) |>
  ggplot(aes(x = pct, y = age_group, fill = offence)) +
  geom_col() +
  geom_text(
    aes(label = lbl),
    position = position_stack(vjust = 0.5),
    size = 3, color = "white"
  ) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Composition of Offence Types within Each Age Group (Q1 2023)",
    x = "Share within Age Group",
    y = "Age Group",
    fill = "Offence"
  ) +
  theme_minimal(base_size = 12)

p_share_labels
# ggsave("age_offence_share.png", p_share_labels, width = 9, height = 6, dpi = 300)

```

Topic 2：
Punishment Length vs Age and Sex
Question:
How does punishment length vary between males and females across different age groups?
introduction:
In this section, we examine whether males and females receive punishments of different lengths, and whether age plays a role in these differences.
We use the PunishmentsQ12023 dataset to visualize the relationship between punishment length and age for both sexes.

```{r}
library(dplyr)
library(ggplot2)
load("./data/CSV/punishments.rdata")

pun_clean <- punishments %>%
  rename(
    sex = Sex,
    age_group = `Age group`,
    no_days_raw = `No of days`
  ) %>%
  mutate(
   
    no_days_raw = ifelse(no_days_raw == ".", NA, no_days_raw),
    no_days = as.numeric(no_days_raw),
    sex = factor(sex),
    age_group = factor(age_group, ordered = TRUE)
  ) %>%
  filter(
    !is.na(sex),
    !is.na(age_group),           
    !is.na(no_days),
    no_days > 0
  )
age_summary <- pun_clean %>%
  group_by(age_group) %>%
  summarise(
    mean_days = mean(no_days),
    se_days = sd(no_days) / sqrt(n())
  )
ggplot(age_summary, aes(x = age_group, y = mean_days, fill = mean_days)) +
  
  geom_col(width = 0.55) +
  

  geom_errorbar(
    aes(ymin = mean_days - se_days, ymax = mean_days + se_days),
    width = 0.15,
    linewidth = 0.5
  ) +
  
 
  geom_text(
    aes(label = round(mean_days, 1)),
    vjust = -0.6,
    size = 3     
  ) +
  

  scale_fill_gradient(
    low = "#a5d8ff",
    high = "#1e90ff",
    name = "Mean days"
  ) +
  
  labs(
    title = "Average Punishment Length by Age Group",
    x = "Age Group",
    y = "Average Punishment Length (days)"
  ) +
  
  
  theme_classic(base_size = 11) +
  
  
  theme(
    axis.text.x = element_text(angle = 35, hjust = 1),
    legend.position = "none"  
  )


```


```{r}
age_stats <- pun_clean %>%
  group_by(age_group) %>%
  summarise(
    n = n(),                 # 每组数量
    mean_days = mean(no_days),
    median_days = median(no_days),
    sd_days = sd(no_days),
    min_days = min(no_days),
    max_days = max(no_days),
    iqr_days = IQR(no_days)
  )

age_stats


```

```{r}
library(tidymodels)


# Convert offence categories into a binary classification variable (severe vs not_severe)
severe_levels <- c("Violence",
                   "Unauthorised transactions",
                   "Drug related offence")

pun_clean <- pun_clean %>% 
  mutate(
    severe = if_else(Offence %in% severe_levels,
                     "severe", "not_severe"),
    severe = factor(severe, levels = c("not_severe", "severe"))
  )


# Fix random numbers by setting the seed 
# Enables analysis to be reproducible when random numbers are used 
set.seed(123)

# Put 80% of the data into the training set 
data_split <- initial_split(pun_clean, prop = 0.8, strata = severe)
# Create data frames for the two sets:
data_train <- training(data_split)
data_test  <- testing(data_split)


#Fit a model to the training dataset
log_spec <- 
  logistic_reg() %>%
  set_engine("glm") 

severe_rec <- recipe(
  severe ~ sex + age_group + Ethnicity + Religion, # formula
  data = data_train) %>%                           # data to use for cataloguing names and types of variables
  step_dummy(all_nominal_predictors()) %>%   #Create dummy variables
  step_zv(all_predictors())        #Remove zero variance variables

summary(severe_rec)


severe_wf <- 
  workflow() %>%
  add_recipe(severe_rec) %>%
  add_model(log_spec)


severe_fit <- severe_wf %>% fit(data = data_train)

tidy(severe_fit)

#Predict probabilities on the testing dataset
severe_pred <- 
  predict(severe_fit, data_test, type = "prob") %>%
  bind_cols(data_test %>% select(severe))


#create ROC diagram and calculate the area
roc_severe <- 
  roc_curve(severe_pred, truth = severe, .pred_severe)

autoplot(roc_severe)

auc_severe <- 
  roc_auc(severe_pred, truth = severe, .pred_severe)

auc_severe


```
```{r}
library(yardstick)
library(ggplot2)

# 生成分类预测（分类结果而不是概率）
severe_pred_class <- predict(severe_fit, data_test) %>%
  bind_cols(data_test %>% select(severe))

# 混淆矩阵
conf_mat(severe_pred_class, truth = severe, estimate = .pred_class) %>%
  autoplot(type = "heatmap") +
  scale_fill_gradient(low = "#a5d8ff", high = "#1e90ff") +
  labs(title = "Confusion Matrix for Logistic Regression",
       x = "Truth",
       y = "Prediction") +
  theme_minimal()

```

