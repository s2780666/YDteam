---
title: "Investigation of Prisoner Population Statistics"
author: "YD_team <br> Cecilia, Frank, Junkai, Zhandos"
institute: "University of Edinburgh"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      
---

```{r install-package, include = FALSE, eval = FALSE}
# Copy and paste the following code into your console to download and install
# the `xaringan` package that contains all of the code which allows you 
# to create presentation slides in Rmarkdown
install.packages('xaringan')
```


```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
library(janitor)
library(readr)

adjudications <- read_csv("data/CSV/AdjudicationsQ12023.csv")

 
adjudications <- adjudications %>%
  clean_names()

adjudications_clean <- adjudications %>%
  drop_na()


adjudications_clean <- adjudications_clean %>%
  rename(quarter = date)
```


```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")
```

```{r load-data, include=FALSE}
# Load your data here

```

```{r include=FALSE}

#Background image
style_xaringan(
  title_slide_background_image = "img/confetti.jpg"
)
```

class: center, middle

##The statement of the overall goal

Age influences both the types of offences prisoners commit and the length of punishments they receive.




---

class: inverse, center, middle

# Topic 1：
Crime Patterns Across Age Groups in UK Prisons (Q1 2023)


---
# Question:

What kinds of crimes are different age groups committing?

Introduction:

Understanding how offences differ across age groups helps reveal behaviour patterns in prisons.
Using the Adjudications Q1 2023 dataset, where each case has an age group and offence type, we look at which offences are most common at different ages and how these patterns change across age groups.
---
class:middle, center
```{r, echo=FALSE, fig.align='center', out.width="60%"}
glimpse(adjudications_clean)
colSums(is.na(adjudications_clean))
```
---
```{r, echo=FALSE, fig.align='center', out.width="80%"}
library(tidyverse)
library(janitor)


adjudications_clean %>%
  group_by(offence) %>%
  summarise(total = sum(count, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(total)) %>%
  slice_head(n = 6) %>%
  ggplot(aes(x = reorder(offence, total), y = total, fill = offence)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Top 6 offences (Q1 2023)",
    x = "Offence",
    y = "Total cases"
  )


```
---

# Crime Patterns Across Age Groups in UK Prisons (Q1 2023)

```{r, include=FALSE, message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(forcats)
library(scales)
library(gt)
library(glue)
library(janitor)

adj <- read_csv("AdjudicationsQ12023.csv") |> clean_names()

adj_clean <- adj |>
  mutate(
    count = suppressWarnings(as.numeric(count)),
    age_group = as.character(age_group),
    offence   = as.character(offence)
  ) |>
  filter(!is.na(age_group), !is.na(offence), !is.na(count), count > 0)

age_order <- c("15 - 17","18 - 20","21 - 24","25 - 29","30 - 39",
               "40 - 49","50 - 59","60 - 69","70 and over")
adj_clean <- adj_clean |>
  mutate(age_group = fct_relevel(age_group, age_order, after = 0))

age_offence_counts <- adj_clean |>
  group_by(age_group, offence) |>
  summarise(total = sum(count), .groups = "drop")

age_totals <- age_offence_counts |>
  group_by(age_group) |>
  summarise(age_total = sum(total), .groups = "drop")

age_offence_share <- age_offence_counts |>
  left_join(age_totals, by = "age_group") |>
  mutate(pct = total / age_total)

p_counts <- age_offence_counts |>
  ggplot(aes(x = total, y = age_group, fill = offence)) +
  geom_col() +
  geom_text(
    data = age_totals,
    aes(x = age_total, y = age_group, label = comma(age_total)),
    nudge_x = max(age_totals$age_total, na.rm = TRUE) * 0.02, 
    inherit.aes = FALSE, size = 3
  ) +
  labs(
    title = "Adjudications by Age Group and Offence (Q1 2023)",
    x = "Total Cases",
    y = "Age Group",
    fill = "Offence"
  ) +
  theme_minimal(base_size = 12)

p_share_labels <- age_offence_share |>
  mutate(lbl = ifelse(pct >= 0.05, percent(pct, accuracy = 1), "")) |>
  ggplot(aes(x = pct, y = age_group, fill = offence)) +
  geom_col() +
  geom_text(
    aes(label = lbl),
    position = position_stack(vjust = 0.5),
    size = 3, color = "white"
  ) +
  scale_x_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Composition of Offence Types within Each Age Group (Q1 2023)",
    x = "Share within Age Group",
    y = "Age Group",
    fill = "Offence"
  ) +
  theme_minimal(base_size = 12)

# This visualization shows us that, proportionally speaking, violence is a more common offence among younger inmates. We can also see that disobedience/disrespect is more common among older inmates. This data is useful as differences in severity of offences committed by different age groups may be a factor in differences in length of punishments.
```

---

# Crime Patterns Across Age Groups in UK Prisons (Q1 2023)

```{r, echo=FALSE, fig.align='center', out.width="60%"}
p_share_labels
```


---
class: inverse, center, middle

# Topic 2：
Punishment Length Across Age Groups
 


---

#Question: 

How does punishment length vary across different age groups?

Introduction:

This section focus on whether punishment length varies across age groups.
Using the Punishments Q1 2023 dataset, we compare the average number of punishment days across different ages to see which groups tend to receive longer or shorter punishments and what these differences might suggest.

```{r, include=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
load("./data/CSV/punishments.rdata")

pun_clean <- punishments %>%
  rename(
    sex = Sex,
    age_group = `Age group`,
    no_days_raw = `No of days`
  ) %>%
  mutate(
    no_days_raw = ifelse(no_days_raw == ".", NA, no_days_raw),
    no_days = as.numeric(no_days_raw),
    sex = factor(sex),
    age_group = factor(age_group, ordered = TRUE)
  ) %>%
  filter(
    !is.na(sex),
    !is.na(age_group),           
    !is.na(no_days),
    no_days > 0
  )

age_summary <- pun_clean %>%
  group_by(age_group) %>%
  summarise(
    mean_days = mean(no_days),
    se_days = sd(no_days) / sqrt(n()),
    .groups = "drop"
  )

p_age_bar <- ggplot(age_summary, aes(x = age_group, y = mean_days, fill = mean_days)) +
  geom_col(width = 0.55) +
  geom_errorbar(
    aes(ymin = mean_days - se_days, ymax = mean_days + se_days),
    width = 0.15,
    linewidth = 0.5
  ) +
  geom_text(
    aes(label = round(mean_days, 1)),
    vjust = -0.6,
    size = 3
  ) +
  scale_fill_gradient(
    low = "#a5d8ff",
    high = "#1e90ff",
    name = "Mean days"
  ) +
  labs(
    title = "Average Punishment Length by Age Group",
    x = "Age Group",
    y = "Average Punishment Length (days)"
  ) +
  theme_classic(base_size = 11) +
  theme(
    axis.text.x = element_text(angle = 35, hjust = 1),
    legend.position = "none"
  )
```

---

# Average Punishment Length by Age Group

```{r, echo=FALSE, fig.align='center', out.width="75%"}
p_age_bar
```

---
class: small

# Tables

the sample size for each age group,
the average punishment length (mean_days),
the median punishment length (median_days),
the standard deviation (sd_days),
the minimum value (min_days),
the maximum value (max_days),
the interquartile range (IQR)
```{r, echo=FALSE, fig.align='center', out.width="60%"}
age_stats <- pun_clean %>%
  group_by(age_group) %>%
  summarise(
    n = n(),
    mean_days = mean(no_days),
    median_days = median(no_days),
    sd_days = sd(no_days),
    min_days = min(no_days),
    max_days = max(no_days),
    iqr_days = IQR(no_days)
  )

age_stats
```

---

# model


```{r, include=FALSE, message=FALSE, warning=FALSE}
library(tidymodels)
library(dplyr)
library(broom)
library(gt)
library(stringr)

# Convert to binary label
severe_levels <- c("Violence",
                   "Unauthorised transactions",
                   "Drug related offence")

pun_clean <- pun_clean %>% 
  mutate(
    severe = if_else(Offence %in% severe_levels,
                     "severe", "not_severe"),
    severe = factor(severe, levels = c("not_severe", "severe"))
  )

set.seed(123)
data_split <- initial_split(pun_clean, prop = 0.8, strata = severe)
data_train <- training(data_split)
data_test  <- testing(data_split)

log_spec <- logistic_reg() %>%
  set_engine("glm")

severe_rec <- recipe(
  severe ~ sex + age_group + Ethnicity + Religion,
  data = data_train) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_zv(all_predictors())

severe_wf <- workflow() %>%
  add_recipe(severe_rec) %>%
  add_model(log_spec)

severe_fit <- fit(severe_wf, data = data_train)

# 全部系数 tidy
coef_tbl <- tidy(severe_fit) %>%
  filter(term != "(Intercept)") %>%
  mutate(
    term = str_replace_all(term, "_", " "),
    term = str_trunc(term, 28),
    estimate  = round(estimate, 3),
    std.error = round(std.error, 3),
    statistic = round(statistic, 2),
    p.value   = signif(p.value, 3)
  )

# 拆成上下两部分
half_n <- ceiling(nrow(coef_tbl) / 2)
coef_tbl_1 <- coef_tbl[1:half_n, ]
coef_tbl_2 <- coef_tbl[(half_n+1):nrow(coef_tbl), ]
```


---
```{r setup_severe_model, include=FALSE, message=FALSE, warning=FALSE}
library(tidymodels)
library(dplyr)

severe_levels <- c("Violence",
                   "Unauthorised transactions",
                   "Drug related offence")

pun_clean <- pun_clean %>% 
  mutate(
    severe = if_else(Offence %in% severe_levels,
                     "severe", "not_severe"),
    severe = factor(severe, levels = c("not_severe", "severe"))
  )


set.seed(123)
data_split <- initial_split(pun_clean, prop = 0.8, strata = severe)
data_train <- training(data_split)
data_test  <- testing(data_split)


log_spec <- logistic_reg() %>% set_engine("glm")

severe_rec <- recipe(
  severe ~ sex + age_group + Ethnicity + Religion,
  data = data_train) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_zv(all_predictors())

severe_wf <- workflow() %>%
  add_recipe(severe_rec) %>%
  add_model(log_spec)

severe_fit <- fit(severe_wf, data = data_train)


severe_pred <- predict(severe_fit, data_test, type = "prob") %>%
  bind_cols(data_test %>% select(severe))

roc_severe <- roc_curve(severe_pred, truth = severe, .pred_severe)
auc_severe <- roc_auc(severe_pred, truth = severe, .pred_severe)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.width="70%"}
library(ggplot2)

ggplot(roc_severe, aes(x = 1 - specificity, y = sensitivity)) +
  geom_line(linewidth = 1) +
  geom_abline(linetype = "dotted") +
  labs(
    title = paste("ROC Curve (AUC =", round(auc_severe$.estimate, 3), ")"),
    x = "1 - Specificity",
    y = "Sensitivity"
  ) +
  theme_minimal(base_size = 12)
```

---
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.width="70%"}
library(yardstick)
library(ggplot2)

severe_pred_class <- predict(severe_fit, data_test) %>%
  bind_cols(data_test %>% select(severe))

conf_mat(severe_pred_class, truth = severe, estimate = .pred_class) %>%
  autoplot(type = "heatmap") +
  scale_fill_gradient(low = "#a5d8ff", high = "#1e90ff") +
  labs(title = "Confusion Matrix for Logistic Regression",
       x = "Truth",
       y = "Prediction") +
  theme_minimal()

sensitivity(severe_pred_class, truth = severe, estimate = .pred_class)


specificity(severe_pred_class, truth = severe, estimate = .pred_class)

```

---

# Conclusion
Topic 1 – Conclusion

Our analysis shows that different age groups tend to commit different kinds of offences.
Younger prisoners are more often involved in rule-breaking behaviours such as disobedience or disrespect, while older age groups show higher involvement in transactional or more serious offences.
This means that offence patterns are clearly linked to age, and age groups do not behave in the same way inside prisons.

Topic 2 – Conclusion

Punishment length also varies across age groups.
Although the differences are not very large, some age groups consistently receive slightly longer punishments than others.
This suggests that age plays a role in how long punishments are assigned, and that disciplinary outcomes may be somewhat different depending on the age group.

---

# Thanks for watching!